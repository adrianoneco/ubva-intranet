name: Copilot Check with Bun and WhatsApp Notify

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      #
      # 1) SINTAX CHECK
      #
      - name: Syntax Check
        id: syntax
        continue-on-error: true
        run: |
          bun check . > syntax_out.txt 2>&1 || true
          CODE=$?
          echo "code=$CODE" >> $GITHUB_OUTPUT

      #
      # 2) INSTALL DEPENDENCIES
      #
      - name: Install Dependencies
        id: install
        continue-on-error: true
        run: |
          bun install > install_out.txt 2>&1 || true
          CODE=$?
          echo "code=$CODE" >> $GITHUB_OUTPUT

      #
      # 3) CHECK OUTDATED PACKAGES
      #
      - name: Check outdated packages
        id: outdated
        run: |
          bun outdated > outdated.txt 2>&1 || true
          if [ -s outdated.txt ]; then
            echo "hasOutdated=true" >> $GITHUB_OUTPUT
          else
            echo "hasOutdated=false" >> $GITHUB_OUTPUT
          fi

      #
      # 4) BUILD FINAL MESSAGE
      #
      - name: Prepare WhatsApp Message
        id: message
        run: |
          # Repo name
          REPO="${GITHUB_REPOSITORY#*/}"

          # Syntax check
          if [ "${{ steps.syntax.outputs.code }}" = "0" ]; then
            SYNTAX="âœ” VerificaÃ§Ã£o de erro de sintaxe"
          else
            SYNTAX="âŒ VerificaÃ§Ã£o de erro de sintaxe"
          fi

          # Install dependencies
          if [ "${{ steps.install.outputs.code }}" = "0" ]; then
            INSTALL="âœ” Instalar dependÃªncias"
          else
            INSTALL="âŒ Instalar dependÃªncias"
          fi

          # Outdated packages
          if [ "${{ steps.outdated.outputs.hasOutdated }}" = "true" ]; then
            OUTDATED="âš ï¸ HÃ¡ pacotes desatualizados"
          else
            OUTDATED="âœ” Nenhum pacote desatualizado"
          fi

          MESSAGE="*ðŸ§ª Copilot Check Project ${REPO}*\n\n$SYNTAX\n$INSTALL\n$OUTDATED"

          echo "msg=$MESSAGE" >> $GITHUB_OUTPUT

      #
      # 5) SEND WHATSAPP
      #
      - name: Send WhatsApp Notification
        run: |
          curl --request POST \
            --url "https://${{ secrets.EVOLUTION_ENDPOINT }}/message/sendText/${{ secrets.INSTANCE_NAME }}" \
            --header "Content-Type: application/json" \
            --header "apikey: ${{ secrets.EVOLUTION_API_KEY }}" \
            --data "{
              \"number\": \"${{ secrets.REMOTEJID }}\",
              \"text\": \"${{ steps.message.outputs.msg }}\"
            }"
