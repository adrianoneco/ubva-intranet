<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Instalar certificado — intranet.ubva.local</title>
  <link rel="icon" href="/favicon.png" />
  <style>
    :root{
      --bg: #f7fafc;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
      --accent: #06b6d4; /* cyan-500 */
      --accent-2: #0ea5e9;
      --danger-bg: #fffbeb;
      --danger-border: #f59e0b;
      --glass: rgba(255,255,255,0.6);
      --shadow: 0 8px 30px rgba(2,6,23,0.08);
      --radius: 12px;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg: #0b1220;
        --card: #071025;
        --text: #e6eef8;
        --muted: #9aa8bf;
        --accent: #2dd4bf;
        --accent-2: #38bdf8;
        --danger-bg: #3b2a0a;
        --danger-border: #f59e0b;
        --glass: rgba(255,255,255,0.03);
        --shadow: 0 10px 30px rgba(2,6,23,0.6);
      }
    }

    html,body{height:100%}
    body{font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;line-height:1.5;padding:32px;margin:0;background:linear-gradient(180deg,var(--bg),rgba(0,0,0,0.02));color:var(--text);-webkit-font-smoothing:antialiased}
    main{max-width:920px;margin:18px auto;background:linear-gradient(180deg,var(--card),var(--glass));padding:28px;border-radius:var(--radius);box-shadow:var(--shadow);border:1px solid rgba(255,255,255,0.03);backdrop-filter: blur(6px)}
    header.top{display:flex;align-items:center;gap:16px}
    header.top img{height:56px;width:auto}
    .title{flex:1}
    h1{font-size:20px;margin:0;color:var(--text)}
    p.lead{color:var(--muted);margin:8px 0 0 0}

    .alert{display:flex;gap:12px;align-items:flex-start;background:var(--danger-bg);border-left:6px solid var(--danger-border);padding:14px;border-radius:10px}
    .alert .icon{width:36px;height:36px;flex:0 0 36px;border-radius:8px;background:linear-gradient(180deg,var(--accent),var(--accent-2));display:inline-grid;place-items:center;color:white}

    .actions{display:flex;gap:10px;margin-top:12px}
    .btn{display:inline-flex;align-items:center;gap:8px;border:0;padding:10px 14px;border-radius:10px;background:var(--accent);color:#04263a;text-decoration:none;font-weight:600;cursor:pointer}
    .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text);font-weight:600}
    .btn.ghost{background:transparent;border:0;color:var(--accent-2)}

    section#details{margin-top:18px}
    .detail-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px}
    /* when expanded (ver mais) stack full width */
    section#details.expanded .detail-cards{grid-template-columns:1fr !important}
    h2{font-size:16px;margin-top:0}
    pre{background:rgba(0,0,0,0.08);color:var(--text);padding:12px;border-radius:8px;overflow:auto}
    code{background:rgba(0,0,0,0.04);padding:2px 6px;border-radius:6px}
    ul{margin-top:6px;color:var(--muted)}
    ol{color:var(--muted)}

    .muted{color:var(--muted)}
    footer{margin-top:18px;color:var(--muted);font-size:13px}

    @media (max-width:700px){
      main{margin:12px;padding:18px}
      header.top{flex-direction:column;align-items:flex-start}
      .actions{flex-direction:column}
      .btn{width:100%}
    }
  </style>
</head>
<body>
  <main>
    <header class="top">
      <img src="/logo-default.png" alt="UBVA" />
      <div class="title">
        <h1>Atenção — certificado necessário</h1>
        <p class="lead">Para acessar <code>https://intranet.ubva.local</code> você precisa instalar o certificado do servidor (.pfx) no seu dispositivo.</p>
      </div>
    </header>

    <div class="alert" role="alert" aria-live="polite">
      <div class="icon" aria-hidden>
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 9v4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 17h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" stroke="rgba(255,255,255,0.9)" stroke-width="0" fill="rgba(255,255,255,0.12)"/></svg>
      </div>
      <div style="flex:1">
        <div style="font-weight:700">Atenção — certificado necessário</div>
        <div class="muted" style="margin-top:6px">Sem o certificado instalado o navegador exibirá avisos de segurança. Importe o arquivo <code>intranet.pfx</code> e marque-o como confiável.</div>
        <div class="actions">
          <a class="btn" id="downloadBtn" href="/ssl/intranet.pfx">Baixar .pfx</a>
          <button id="toggleDetails" class="btn secondary">Ver mais</button>
        </div>
      </div>
    </div>

    <section id="details" style="display:none;margin-top:18px">
      <h2>Detalhes — como instalar</h2>
      <p class="muted">Passos resumidos para Windows, macOS e Linux. Expanda para ver comandos e notas.</p>

      <div class="detail-cards" style="margin-top:12px;display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px">
        <div style="background:var(--card);padding:12px;border-radius:10px;border:1px solid rgba(0,0,0,0.04)">
          <h3 style="margin-top:0">Windows</h3>
          <ol class="muted">
            <li>Abra <code>mmc</code> &gt; Add/Remove Snap-in &gt; Certificados (Computer account).</li>
            <li>Trusted Root Certification Authorities &gt; Certificates &gt; Import &gt; selecione <code>.pfx</code>.</li>
          </ol>
          <pre class="muted">Import-PfxCertificate -FilePath C:\\caminho\\intranet.pfx -CertStoreLocation Cert:\\LocalMachine\\Root</pre>
        </div>

        <div style="background:var(--card);padding:12px;border-radius:10px;border:1px solid rgba(0,0,0,0.04)">
          <h3 style="margin-top:0">macOS</h3>
          <ol class="muted">
            <li>Abra Keychain Access &gt; File &gt; Import Items... &gt; selecione o <code>.pfx</code>.</li>
            <li>Selecione <em>System</em> e marque <em>Always Trust</em> se necessário.</li>
          </ol>
        </div>

        <div style="background:var(--card);padding:12px;border-radius:10px;border:1px solid rgba(0,0,0,0.04)">
          <h3 style="margin-top:0">Linux</h3>
          <ol class="muted">
            <li>Importe no Firefox (Preferences &gt; Certificates &gt; Import)</li>
            <li>Ou converta para PEM e instale no store do sistema.</li>
          </ol>
          <pre class="muted">openssl pkcs12 -in intranet.pfx -out intranet.pem -nodes
sudo cp intranet.crt /usr/local/share/ca-certificates/
sudo update-ca-certificates</pre>
        </div>
      </div>

      <h3 style="margin-top:16px">Hosts / DNS (opcional)</h3>
      <pre class="muted">sudo -- sh -c 'echo "192.168.3.38 intranet.ubva.local" >> /etc/hosts'</pre>

      <h3 style="margin-top:8px">Suporte</h3>
      <p class="muted">Se precisar, contate <strong>suporte@ubva.local</strong> com OS, navegador e mensagens de erro.</p>
    </section>
  </main>
  <script>
    (function(){
      const btn = document.getElementById('toggleDetails');
      const details = document.getElementById('details');
      if(!btn || !details) return;
      btn.addEventListener('click', function(){
        const shown = details.style.display === 'block';
        details.style.display = shown ? 'none' : 'block';
        btn.textContent = shown ? 'Ver mais' : 'Ver menos';
        // focus download button when showing details
        if(!shown) document.getElementById('downloadBtn')?.focus();
      });
    })();
  </script>
  <div id="verifyingModal" aria-hidden="true" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(2,6,23,0.6);z-index:9999">
    <div style="background:var(--card);padding:20px;border-radius:12px;max-width:520px;width:92%;text-align:center;box-shadow:var(--shadow)">
      <div style="font-weight:700;font-size:18px;margin-bottom:8px">Verificando sua conexão</div>
      <div class="muted" id="verifyMsg">Verificando se <code>https://intranet.ubva.local</code> possui TLS válido...</div>
      <div style="margin-top:12px" id="verifyControls">
        <button class="btn ghost" id="verifyCancel">Fechar</button>
      </div>
    </div>
  </div>
  <script>
    (function(){
      const modal = document.getElementById('verifyingModal');
      const msg = document.getElementById('verifyMsg');
      const controls = document.getElementById('verifyControls');
      const cancel = document.getElementById('verifyCancel');
      function hideModal(){ if(modal) modal.style.display='none'; }
      function showModal(){ if(modal) modal.style.display='flex'; }

      cancel?.addEventListener('click', ()=>{ hideModal(); });

      async function checkHttps() {
        const target = 'https://intranet.ubva.local/';
        // Try to fetch the root using no-cors: success means browser could connect with HTTPS
        const controller = new AbortController();
        const timeout = setTimeout(()=>controller.abort(), 6000);
        try{
          // Use no-cors so that opaque response still counts as reachable; if TLS invalid the fetch should fail
          await fetch(target, {mode:'no-cors', cache:'no-store', signal: controller.signal});
          clearTimeout(timeout);
          return true;
        }catch(e){
          clearTimeout(timeout);
          return false;
        }
      }

      async function runCheck(){
        showModal();
        const ok = await checkHttps();
        if(ok){
          // show countdown and redirect
          let seconds = 10;
          msg.textContent = `Conexão segura detectada. Você será redirecionado para https://intranet.ubva.local em ${seconds} segundos.`;
          const nowBtn = document.createElement('a');
          nowBtn.className = 'btn';
          nowBtn.href = 'https://intranet.ubva.local';
          nowBtn.textContent = 'Ir agora';
          const cancelBtn = document.createElement('button');
          cancelBtn.className = 'btn secondary';
          cancelBtn.textContent = 'Cancelar';
          cancelBtn.addEventListener('click', ()=>{ hideModal(); });
          controls.innerHTML = '';
          controls.appendChild(nowBtn);
          controls.appendChild(cancelBtn);
          const interval = setInterval(()=>{
            seconds--;
            if(seconds <= 0){ clearInterval(interval); window.location.href = 'https://intranet.ubva.local'; }
            else { msg.textContent = `Conexão segura detectada. Você será redirecionado para https://intranet.ubva.local em ${seconds} segundos.`; }
          },1000);
        } else {
          // show instructions (hide modal and expand details)
          hideModal();
          // show an extra warning in page
          const warn = document.createElement('div');
          warn.style.marginTop = '12px';
          warn.style.padding = '12px';
          warn.style.borderRadius = '8px';
          warn.style.background = 'linear-gradient(90deg, rgba(255,235,238,0.9), rgba(255,249,230,0.9))';
          warn.style.borderLeft = '4px solid #f43f5e';
          warn.innerHTML = `<strong>Não foi possível estabelecer uma conexão HTTPS válida com <code>intranet.ubva.local</code>.</strong> Siga as instruções abaixo para instalar o certificado ou contate <strong>suporte@ubva.local</strong>.`;
          document.querySelector('main')?.insertBefore(warn, document.querySelector('#details'));
          // ensure details are visible
          const details = document.getElementById('details');
          if(details) details.style.display = 'block';
          const toggle = document.getElementById('toggleDetails');
          if(toggle) toggle.textContent = 'Ver menos';
        }
      }

      // run on load
      if(document.readyState === 'complete' || document.readyState === 'interactive'){
        setTimeout(runCheck, 300);
      } else {
        window.addEventListener('DOMContentLoaded', ()=> setTimeout(runCheck, 300));
      }
    })();
  </script>
</body>
</html>
